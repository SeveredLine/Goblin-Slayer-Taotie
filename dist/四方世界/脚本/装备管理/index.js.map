{"version":3,"file":"index.js","mappings":"AACA,IAAIA,EAAsB,CCA1BA,EAAyBC,IACxB,IAAIC,EAASD,GAAUA,EAAOE,WAC7B,IAAOF,EAAiB,QACxB,IAAM,EAEP,OADAD,EAAoBI,EAAEF,EAAQ,CAAEG,EAAGH,IAC5BA,GCLRF,EAAwB,CAACM,EAASC,KACjC,IAAI,IAAIC,KAAOD,EACXP,EAAoBS,EAAEF,EAAYC,KAASR,EAAoBS,EAAEH,EAASE,IAC5EE,OAAOC,eAAeL,EAASE,EAAK,CAAEI,YAAY,EAAMC,IAAKN,EAAWC,MCJ3ER,EAAwB,CAACc,EAAKC,IAAUL,OAAOM,UAAUC,eAAeC,KAAKJ,EAAKC,ICAlF,MAAM,EAA+BI,E,aCGrC,MAAMC,EAAKC,OAAeD,EAEpBE,EAAW,OACXC,EAAM,CAAEC,KAAM,UAAWC,WAAY,UAsBrCC,EAAe,CAACC,EAAWnB,IAAgBmB,GAAMC,MAAQD,GAAM,IAAMnB,GAAO,GA4ElFY,EAAE,KACA,WACE,UACSC,OAAeQ,aAAa,YAAYP,IACjD,CAAE,MAAOQ,GACPC,QAAQC,MAAM,gBAAiBF,EACjC,CACD,EAND,GAQCT,OAAeY,QAASZ,OAAea,eAAeZ,GAAW,KAChE,IACE,MACMa,EA5GI,CAACC,GAAc,QAAMA,EAAM,eAAgB,QAAMA,EAAM,KAAM,CAAC,KAAO,CAAC,EA4GnEC,CADChB,OAAeiB,aAAaf,IAEpCgB,EAjGQ,CAACA,IACnB,MAAMC,EAAOD,GAA0B,iBAAVA,EAAqB,cAAYA,GAAS,CAAC,EAIxE,MAHA,CAAC,KAAM,KAAM,MAAME,QAAQC,IACpBF,EAAKE,IAA6B,iBAAdF,EAAKE,KAAmBF,EAAKE,GAAO,CAAC,KAEzDF,GA4FWG,CAAYR,EAAK,IACzBS,EA5GM,CAACA,IACjB,MAAMJ,EAAOI,GAAsB,iBAARA,EAAmB,cAAYA,GAAO,CAAC,EAMlE,MALmB,CAAC,KAAM,KAAM,KAAM,MAAO,MAClCH,QAAQC,IACZF,EAAKE,IAA6B,iBAAdF,EAAKE,KAAmBF,EAAKE,GAAO,CAAC,KAE3DF,EAAK,KAAIA,EAAK,GAAK,CAAE,GAAI,EAAG,GAAI,EAAG,GAAI,IACrCA,GAqGSK,CAAUV,EAAK,IAErBW,EAASzB,OAAO0B,OAAO,gCAAiC,KAE9D,GAAe,MAAXD,EAAgB,CAClB,MAAME,EA7FY,EAACT,EAAYK,KACrC,IAAII,EAAQ,EAsBZ,MADA,CAAC,KAAM,KAAM,MAAMP,QApBGC,IACpB,MAAMO,EAAMV,EAAMG,IAAQ,CAAC,EAC3BhC,OAAOwC,QAAQD,GAAKR,QAAQ,EAAEjC,EAAKmB,MACjC,IAAKA,GAAiB,SAATA,EAAiB,OAC9B,MAAMC,EAAOF,EAAaC,EAAMnB,GAChC,IAAKoB,EAAM,OAEX,MAAMuB,EAAYP,EAAIF,KAASE,EAAIF,GAAO,CAAC,GACrCU,EAAWD,EAAUvB,GACrByB,EAAYD,GAAYE,OAAOF,EAASC,WAAc,EAEtDE,EAAO,cAAY5B,GACzB4B,EAAKF,SAAWA,EAAW,EAE3BF,EAAUvB,GAAQ2B,EAClBP,GAAS,IAEXT,EAAMG,GAAO,CAAC,IAITM,GAsEaQ,CAAkBjB,EAAOK,GACvC,GAAc,IAAVI,EAEF,YADC3B,OAAeoC,OAAOC,KAAK,YAG7BrC,OAAesC,YAAY,kBAAmBpB,EAAOhB,GACrDF,OAAesC,YAAY,kBAAmBf,EAAKrB,GACnDF,OAAeoC,OAAOG,QAAQ,OAAOZ,cACxC,MAAO,GAAe,MAAXF,EAAgB,CACzB,MAAMe,EAA2B,GAYjC,GAXA,CAAC,KAAM,KAAM,MAAMpB,QAAQC,IACzB,MAAMoB,EAAWlB,EAAIF,IAAQ,CAAC,EAC9BhC,OAAOwC,QAAQY,GAAUrB,QAAQ,EAAEjC,EAAKmB,MACtC,MAAMC,EAAOF,EAAaC,EAAMnB,GAC1B6C,EAAW1B,EAAK0B,UAAY,EAC9BzB,GAAQyB,EAAW,GACrBQ,EAAeE,KAAK,GAAGnC,MAASc,UAAYW,UAKpB,IAA1BQ,EAAeG,OAEjB,YADC3C,OAAeoC,OAAOC,KAAK,eAI9B,MAAMO,EAAY5C,OAAO0B,OAAO,cAAcc,EAAeK,KAAK,oBAAqB,IACvF,IAAKD,EAAW,OAEhB,MAAME,EAhGO,EAAC5B,EAAYK,EAAUwB,KAC1C,IAAIC,EAAiB,KACjBC,EAAgB,KAChBC,EAAgB,KAEpB,IAAK,MAAM7B,IAAO,CAAC,KAAM,KAAM,MAAO,CACpC,MAAMoB,EAAWlB,EAAIF,IAAQ,CAAC,EAC9B,IAAK,MAAOlC,EAAKmB,KAASjB,OAAOwC,QAAQY,GACvC,GAAIpC,EAAaC,EAAMnB,KAAS4D,IAAczC,EAAa0B,UAAY,GAAK,EAAG,CAC7EgB,EAAY1C,EACZ2C,EAAW5B,EACX6B,EAAW/D,EACX,KACF,CAEF,GAAI6D,EAAW,KACjB,CAEA,IAAKA,EAAW,MAAM,IAAIG,MAAM,aAAaJ,KAE7C,MAAMK,EAAOJ,EAAUI,MAAQJ,EAAU,GACzC,IAAKI,EAAM,MAAM,IAAID,MAAM,MAAMJ,YAEjC,MAAMM,EAAenC,EAAM+B,KAAYG,GACvC,GAAIC,EAAc,CAChB,MAAMC,EAAUjD,EAAagD,EAAcD,GACrCG,EAAehC,EAAI0B,KAAc1B,EAAI0B,GAAY,CAAC,GAClDO,EAAcD,EAAaD,GAC3BG,EAAeD,GAAevB,OAAOuB,EAAYxB,WAAc,EAC/D0B,EAAU,cAAYL,GAC5BK,EAAQ1B,SAAWyB,EAAc,EACjCF,EAAaD,GAAWI,CAC1B,CAEA,MAAMC,EAAWzC,EAAM+B,KAAc/B,EAAM+B,GAAY,CAAC,GAClDW,EAAU,cAAYZ,GAU5B,cATOY,EAAQ5B,SACf2B,EAASP,GAAQQ,EAEbZ,EAAUhB,SAAW,EACvBgB,EAAUhB,UAAY,SAEfT,EAAI0B,GAAUC,GAGhB,CAAEW,SAAUd,EAAUe,WAAYT,EAAehD,EAAagD,EAAcD,GAAQ,OAmDtEW,CAAa7C,EAAOK,EAAKqB,EAAUoB,QACjDhE,OAAesC,YAAY,kBAAmBpB,EAAOhB,GACrDF,OAAesC,YAAY,kBAAmBf,EAAKrB,GAEpD,IAAI+D,EAAU,OAAOnB,EAAOe,WACxBf,EAAOgB,aAAYG,GAAW,QAAQnB,EAAOgB,cAChD9D,OAAeoC,OAAOG,QAAQ0B,EACjC,MACGjE,OAAeoC,OAAO8B,QAAQ,OAEnC,CAAE,MAAOzD,GACPC,QAAQC,MAAM,cAAeF,GAC5BT,OAAeoC,OAAOzB,MAAM,iBAAmBF,EAAIwD,QACtD","sources":["src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/compat get default export","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","src://tavern_helper_template/external var \"_\"","src://tavern_helper_template/src/四方世界/脚本/装备管理/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = _;","import _ from 'lodash';\n\n// ST_API functions are accessed via (window as any) currently.\nconst $ = (window as any).$;\n\nconst BTN_NAME = '装备管理';\nconst CTX = { type: 'message', message_id: 'latest' } as const;\n\nconst getHero = (vars: any) => _.get(vars, 'stat_data.主角', _.get(vars, '主角', {})) || {};\n\nconst ensureBag = (bag: any) => {\n  const base = bag && typeof bag === 'object' ? _.cloneDeep(bag) : {};\n  const categories = ['武器', '防具', '饰品', '消耗品', '材料'];\n  categories.forEach(cat => {\n    if (!base[cat] || typeof base[cat] !== 'object') base[cat] = {};\n  });\n  if (!base.金钱) base.金钱 = { 金币: 0, 银币: 0, 铜币: 0 };\n  return base;\n};\n\nconst ensureEquip = (equip: any) => {\n  const base = equip && typeof equip === 'object' ? _.cloneDeep(equip) : {};\n  ['武器', '防具', '饰品'].forEach(cat => {\n    if (!base[cat] || typeof base[cat] !== 'object') base[cat] = {};\n  });\n  return base;\n};\n\nconst getEquipName = (item: any, key: string) => item?.name || item?.名称 || key || '';\n\nconst performUnequipAll = (equip: any, bag: any) => {\n  let moved = 0;\n  const moveCategory = (cat: string) => {\n    const src = equip[cat] || {};\n    Object.entries(src).forEach(([key, item]: [string, any]) => {\n      if (!item || item === '待初始化') return;\n      const name = getEquipName(item, key);\n      if (!name) return;\n\n      const targetCat = bag[cat] || (bag[cat] = {});\n      const existing = targetCat[name];\n      const quantity = (existing && Number(existing.quantity)) || 0;\n\n      const copy = _.cloneDeep(item);\n      copy.quantity = quantity + 1;\n\n      targetCat[name] = copy;\n      moved += 1;\n    });\n    equip[cat] = {};\n  };\n\n  ['武器', '防具', '饰品'].forEach(moveCategory);\n  return moved;\n};\n\nconst performEquip = (equip: any, bag: any, itemName: string) => {\n  let foundItem: any = null;\n  let foundCat: any = null;\n  let foundKey: any = null;\n\n  for (const cat of ['武器', '防具', '饰品']) {\n    const catItems = bag[cat] || {};\n    for (const [key, item] of Object.entries(catItems)) {\n      if (getEquipName(item, key) === itemName && ((item as any).quantity || 1) > 0) {\n        foundItem = item;\n        foundCat = cat;\n        foundKey = key;\n        break;\n      }\n    }\n    if (foundItem) break;\n  }\n\n  if (!foundItem) throw new Error(`背包中未找到装备: ${itemName}`);\n\n  const part = foundItem.part || foundItem.部位;\n  if (!part) throw new Error(`装备 ${itemName} 缺少部位信息`);\n\n  const existingItem = equip[foundCat]?.[part];\n  if (existingItem) {\n    const oldName = getEquipName(existingItem, part);\n    const oldTargetCat = bag[foundCat] || (bag[foundCat] = {});\n    const oldExisting = oldTargetCat[oldName];\n    const oldQuantity = (oldExisting && Number(oldExisting.quantity)) || 0;\n    const oldCopy = _.cloneDeep(existingItem);\n    oldCopy.quantity = oldQuantity + 1;\n    oldTargetCat[oldName] = oldCopy;\n  }\n\n  const equipCat = equip[foundCat] || (equip[foundCat] = {});\n  const newItem = _.cloneDeep(foundItem);\n  delete newItem.quantity;\n  equipCat[part] = newItem;\n\n  if (foundItem.quantity > 1) {\n    foundItem.quantity -= 1;\n  } else {\n    delete bag[foundCat][foundKey];\n  }\n\n  return { equipped: itemName, unequipped: existingItem ? getEquipName(existingItem, part) : null };\n};\n\n$(() => {\n  (async () => {\n    try {\n      await (window as any).triggerSlash(`/buttons ${BTN_NAME}`);\n    } catch (err) {\n      console.error('[装备管理] 显示按钮失败', err);\n    }\n  })();\n\n  (window as any).eventOn((window as any).getButtonEvent(BTN_NAME), () => {\n    try {\n      const vars = (window as any).getVariables(CTX);\n      const hero = getHero(vars);\n      const equip = ensureEquip(hero.装备);\n      const bag = ensureBag(hero.背包);\n\n      const action = window.prompt('选择操作：\\n1. 一键脱衣\\n2. 穿衣\\n请输入数字：', '1');\n\n      if (action === '1') {\n        const moved = performUnequipAll(equip, bag);\n        if (moved === 0) {\n          (window as any).toastr.info('没有可脱下的装备');\n          return;\n        }\n        (window as any).setVariable('stat_data.主角.装备', equip, CTX);\n        (window as any).setVariable('stat_data.主角.背包', bag, CTX);\n        (window as any).toastr.success(`已脱下 ${moved} 件装备，并移入背包`);\n      } else if (action === '2') {\n        const availableItems: string[] = [];\n        ['武器', '防具', '饰品'].forEach(cat => {\n          const catItems = bag[cat] || {};\n          Object.entries(catItems).forEach(([key, item]: [string, any]) => {\n            const name = getEquipName(item, key);\n            const quantity = item.quantity || 1;\n            if (name && quantity > 0) {\n              availableItems.push(`${name} (${cat}, 数量: ${quantity})`);\n            }\n          });\n        });\n\n        if (availableItems.length === 0) {\n          (window as any).toastr.info('背包中没有可装备的物品');\n          return;\n        }\n\n        const itemInput = window.prompt(`选择要装备的物品：\\n${availableItems.join('\\n')}\\n\\n请输入装备名称：`, '');\n        if (!itemInput) return;\n\n        const result = performEquip(equip, bag, itemInput.trim());\n        (window as any).setVariable('stat_data.主角.装备', equip, CTX);\n        (window as any).setVariable('stat_data.主角.背包', bag, CTX);\n\n        let message = `已装备 ${result.equipped}`;\n        if (result.unequipped) message += `，替换了 ${result.unequipped}`;\n        (window as any).toastr.success(message);\n      } else {\n        (window as any).toastr.warning('无效选择');\n      }\n    } catch (err: any) {\n      console.error('[装备管理] 操作失败', err);\n      (window as any).toastr.error('装备管理失败，请查看控制台：' + err.message);\n    }\n  });\n});\n\nexport { };\n\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","_","$","window","BTN_NAME","CTX","type","message_id","getEquipName","item","name","triggerSlash","err","console","error","eventOn","getButtonEvent","hero","vars","getHero","getVariables","equip","base","forEach","cat","ensureEquip","bag","ensureBag","action","prompt","moved","src","entries","targetCat","existing","quantity","Number","copy","performUnequipAll","toastr","info","setVariable","success","availableItems","catItems","push","length","itemInput","join","result","itemName","foundItem","foundCat","foundKey","Error","part","existingItem","oldName","oldTargetCat","oldExisting","oldQuantity","oldCopy","equipCat","newItem","equipped","unequipped","performEquip","trim","message","warning"],"sourceRoot":""}