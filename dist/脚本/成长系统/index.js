!async function(){'function'==typeof window.waitGlobalInitialized&&await window.waitGlobalInitialized('Mvu');const t=window.Mvu?.events||{},n=t.VARIABLE_UPDATE_STARTED||'mag_variable_update_started',o=t.VARIABLE_UPDATE_ENDED||'mag_variable_update_ended',e='function'==typeof window.eventOn?window.eventOn:()=>{};let c=null;function i(t,n,o){t&&(t.display_data||(t.display_data={}),t.display_data[n]=(t.display_data[n]?t.display_data[n]+'\n':'')+o)}function s(t){const n=parseFloat(t);return isNaN(n)?0:n}function f(t,n){if(!t||!n)return null;const o=t.背包,e=['武器','防具','饰品','消耗品','材料','杂物'];if(o&&'object'==typeof o)for(const t of e){const e=o[t];if(e&&'object'==typeof e&&Object.prototype.hasOwnProperty.call(e,n))return e[n]}return null}e(n,function(t){const n=t?.stat_data?.主角?.背包?.金钱;if(n)try{c=JSON.parse(JSON.stringify(n))}catch(t){c=null}});const r={1:1e3,2:1500,3:2500,4:4e3,5:6e3,6:9e3,7:13e3,8:2e4,9:3e4,10:5e4};const l=['初级','中级','高级','精通','大师'];function u(t){const n=t?.主角;if(n)for(const t of['生命值','魔力值','信仰力值','体力值','护甲值']){const o=n[t];if(o&&null!=o.当前值&&null!=o.最大值){const t=s(o.当前值),n=s(o.最大值);isFinite(n)&&t>n&&(o.当前值=n)}}}function a(t){if(!t||!t.装备)return;const n=t.装备;['武器','防具','饰品'].forEach(o=>{n[o]&&'object'==typeof n[o]&&Object.entries(n[o]).forEach(([e,c])=>{'string'==typeof c&&(f(t,c)||delete n[o][e])})})}function d(t){if(!t||!t.装备)return;const n=t.装备.武器||{};let o=!1;if(Object.values(n).forEach(n=>{const e='string'==typeof n?f(t,n):n;e&&'双手'===String(e.hands||'').trim()&&(o=!0)}),o){const o={};Object.entries(n).forEach(([n,e])=>{const c='string'==typeof e?f(t,e):e;c&&'双手'===String(c.hands||'').trim()&&(o[n]=e)}),t.装备.武器=o}}function b(t){if(!t||!t.能力)return;const n=['力量','敏捷','感知','知识','魅力','魔力','信仰力'],o=t.装备||{},e=t.当前状态||{};function c(n,o){if(!n)return 0;if('object'==typeof n&&null!==n)return n.attributes_bonus?s(n.attributes_bonus[o]):0;const e=f(t,n);return e?.attributes_bonus?s(e.attributes_bonus[o]):0}for(const i of n){let n=s(t.能力[i]??0);['武器','防具','饰品'].forEach(t=>{o[t]&&Object.values(o[t]).forEach(t=>{n+=c(t,i)})});for(const t in e){const o=e[t];o?.attributes_bonus?.[i]&&(n+=s(o.attributes_bonus[i]))}t.能力[i]=Math.max(1,n)}}function p(t){if(!t||!t.能力)return;const n=10+5*s(t.能力.力量)+2*s(t.能力.感知);t.生命值=t.生命值||{当前值:0,最大值:0},t.生命值.最大值!==n&&(t.生命值.最大值=n,s(t.生命值.当前值)>n&&(t.生命值.当前值=n));const o=s(t.能力.魔力);t.魔力值=t.魔力值||{当前值:0,最大值:0},t.魔力值.最大值!==o&&(t.魔力值.最大值=o,s(t.魔力值.当前值)>o&&(t.魔力值.当前值=o));const e=s(t.能力.信仰力);t.信仰力值=t.信仰力值||{当前值:0,最大值:0},t.信仰力值.最大值!==e&&(t.信仰力值.最大值=e,s(t.信仰力值.当前值)>e&&(t.信仰力值.当前值=e));const c=5+s(t.能力.敏捷)+s(t.能力.力量);t.体力值=t.体力值||{当前值:0,最大值:0},t.体力值.最大值!==c&&(t.体力值.最大值=c,s(t.体力值.当前值)>c&&(t.体力值.当前值=c));let i=0;const r=t.装备||{};['武器','防具','饰品'].forEach(n=>{r[n]&&Object.values(r[n]).forEach(n=>{i+=function(n){if(!n)return 0;if('object'==typeof n&&null!==n)return s(n?.armor_value);const o=f(t,n);return s(o?.armor_value)}(n)})}),t.护甲值=t.护甲值||{当前值:0,最大值:0},t.护甲值.最大值!==i&&(t.护甲值.最大值=i,s(t.护甲值.当前值)>i&&(t.护甲值.当前值=i))}const y=.75,h=.5,j=.2;function E(t){if(!t||!t.体力值||null==t.体力值.最大值||null==t.体力值.当前值)return;const n=s(t.体力值.当前值)/Math.max(1,s(t.体力值.最大值));let o=null;n<=j?o='过度疲劳':n<=h?o='疲劳':n<=y&&(o='有点累'),t.当前状态=t.当前状态||{};const e=!!t.当前状态['有点累'],c=!!t.当前状态['疲劳'],i=!!t.当前状态['过度疲劳'];if('有点累'!==o&&e&&delete t.当前状态['有点累'],'疲劳'!==o&&c&&delete t.当前状态['疲劳'],'过度疲劳'!==o&&i&&delete t.当前状态['过度疲劳'],o&&!t.当前状态[o]){const n={有点累:'体力下降，注意节奏。对检定略有影响。',疲劳:'明显疲惫，动作迟缓。对检定有中等减益。',过度疲劳:'极度疲乏，注意休息！对检定有显著减益，易入睡。'},e={有点累:-1,疲劳:-2,过度疲劳:-4};t.当前状态[o]={type:'临时',level:'1',description:n[o],attributes_bonus:{},special_effects:{roll_modifier:e[o]}}}}const v=100,w=100;e(o,function(t){if(!t||!t.stat_data)return;const n=t.stat_data,o=[];try{if(function(t){const n=t?.地图位标;if(n&&'object'==typeof n)for(const t in n)null===n[t]&&delete n[t];const o=t?.敌人列表;if(o&&'object'==typeof o)for(const t in o)null===o[t]&&delete o[t]}(n),function(t){const n=t?.主角;if(n&&n.疲劳度&&(n.体力值=n.体力值||{},null==n.体力值.当前值&&null!=n.疲劳度.当前值&&(n.体力值.当前值=n.疲劳度.当前值),null==n.体力值.最大值&&null!=n.疲劳度.最大值&&(n.体力值.最大值=n.疲劳度.最大值),delete n.疲劳度),t.关系列表&&'object'==typeof t.关系列表)for(const n in t.关系列表){const o=t.关系列表[n];o&&o.疲劳度&&(o.体力值=o.体力值||{},null==o.体力值.当前值&&null!=o.疲劳度.当前值&&(o.体力值.当前值=o.疲劳度.当前值),null==o.体力值.最大值&&null!=o.疲劳度.最大值&&(o.体力值.最大值=o.疲劳度.最大值),delete o.疲劳度)}}(n),function(t,n){const o=t?.主角;if(o&&o.职业经验&&'object'==typeof o.职业&&null!=o.经验等级&&null!=o.职业点数)for(;s(o.职业经验.当前值)>=s(o.职业经验.升级所需);){const t=s(o.职业经验.升级所需);if(t<=0)break;o.职业经验.当前值=s(o.职业经验.当前值)-t,o.经验等级=parseInt(o.经验等级,10)+1,o.职业点数=parseInt(o.职业点数,10)+1,o.职业经验.升级所需=r[o.经验等级]||Math.round(1.5*t),n.push(`经验等级提升至 ${o.经验等级} 级！获得 1 技能点！`)}}(n,o),function(t,n){const o=t?.主角;if(o&&o.历练进度&&o.能力)for(const t in o.历练进度){const e=s(o.历练进度[t]),c=100;if(e<c)continue;const i=Math.floor(e/c);i<=0||(o.历练进度[t]=e-i*c,null!=o.能力[t]&&(o.能力[t]=s(o.能力[t])+i,'力量'===t&&(o.生命值=o.生命值||{当前值:0,最大值:0},o.生命值.当前值=s(o.生命值.当前值)+5*i,o.体力值=o.体力值||{当前值:0,最大值:0},o.体力值.当前值=s(o.体力值.当前值)+1*i),'感知'===t&&(o.生命值=o.生命值||{当前值:0,最大值:0},o.生命值.当前值=s(o.生命值.当前值)+2*i),'敏捷'===t&&(o.体力值=o.体力值||{当前值:0,最大值:0},o.体力值.当前值=s(o.体力值.当前值)+1*i),'魔力'===t&&(o.魔力值=o.魔力值||{当前值:0,最大值:0},o.魔力值.当前值=s(o.魔力值.当前值)+1*i),'信仰力'===t&&(o.信仰力值=o.信仰力值||{当前值:0,最大值:0},o.信仰力值.当前值=s(o.信仰力值.当前值)+1*i),n.push(`【${t}】属性突破！提升至 ${o.能力[t]}！(×${i})`)))}}(n,o),function(t,n){const o=t?.主角;if(o&&o.技能列表)for(const t in o.技能列表){const e=o.技能列表[t];if(e&&e.经验&&'string'==typeof e.等级&&!(l.indexOf(e.等级)<0))for(;s(e.经验.当前值)>=s(e.经验.升级所需);){const o=s(e.经验.升级所需);if(o<=0)break;const c=l.indexOf(e.等级);if(c>=l.length-1)break;const i=l[c+1];e.经验.当前值=s(e.经验.当前值)-o,e.等级=i,e.经验.升级所需=Math.round(1.5*o),n.push(`技能【${t}】提升至【${i}】！`)}}}(n,o),u(n),n.主角&&(a(n.主角),d(n.主角),b(n.主角),p(n.主角),E(n.主角)),n.关系列表&&'object'==typeof n.关系列表)for(const t in n.关系列表){const o=n.关系列表[t];o&&!0===o.在场&&(a(o),d(o),b(o),p(o),E(o),u({主角:o}))}!function(t,n){const o=t?.主角?.背包?.金钱;if(!o)return;let e=s(o.金币),f=s(o.银币),r=s(o.铜币);if(e<0){const t=-e,s=t*w,l=Math.max(0,f),u=Math.max(0,s-l),a=u*v;r>=a?(a>0&&(o.铜币=r-a,o.银币=f+u,r=o.铜币,f=o.银币),o.银币=f-s,o.金币=e+t,i(n,'交易提示',`购买成功：用 ${s} 银币（不足部分用 ${a} 铜币换得）抵扣 ${t} 金币`)):(i(n,'交易提示',`购买失败：金币不足，且银/铜不足以按需换算（缺少 ${t} 金）。已取消金币扣费`),o.金币=c?c.金币:e+t)}if(e=s(o.金币),f=s(o.银币),r=s(o.铜币),f<0){const t=-f,e=Math.ceil(t/w);if(e>0&&o.金币>=e)o.金币=o.金币-e,o.银币=f+e*w,i(n,'交易提示',`购买成功：用 ${e} 金币换得 ${e*w} 银币抵扣 ${t} 银币`);else{const e=t*v;o.铜币>=e?(o.铜币=r-e,o.银币=f+t,i(n,'交易提示',`购买成功：消耗 ${e} 铜币抵扣 ${t} 银币（自动换算）`)):(i(n,'交易提示',`购买失败：银币不足，且金币/铜币不足以按需换算（缺少 ${t} 银）。已取消银币扣费`),o.银币=c?c.银币:f+t)}}if(r=s(o.铜币),f=s(o.银币),r<0){const t=-r,e=Math.ceil(t/v);e>0&&o.银币>=e?(o.银币=o.银币-e,o.铜币=r+e*v,i(n,'交易提示',`购买成功：用 ${e} 银币换得 ${e*v} 铜币抵扣 ${t} 铜币`)):(i(n,'交易提示',`购买失败：铜币不足，且银币不足以按需换算（缺少 ${t} 铜）。已取消铜币扣费`),o.铜币=c?c.铜币:r+t)}}(n,t),function(t){const n=t?.地图位标;if(n&&'object'==typeof n)for(const t in n){const o=n[t];o&&'object'==typeof o&&!0===o.临时&&(n[t]=null)}}(n),function(t){const n=t?.敌人列表;if(n&&'object'==typeof n)for(const t in n){const o=s(n[t]?.生命值?.当前值);isFinite(o)&&o<=0&&(n[t]=null)}}(n),o.length>0&&i(t,'系统提示',o.join(' | '))}catch(t){console.error('[Integrated Engine v2.3] 运行异常:',t)}})}();
//# sourceMappingURL=index.js.map